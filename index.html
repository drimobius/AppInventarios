<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scanner KTMEX - PC</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --bg-color: #f8f9fa; --card-bg: #ffffff; --text-color: #212529; --primary: #0056b3; }
        .dark-mode { --bg-color: #1a1a1a; --card-bg: #2d2d2d; --text-color: #f8f9fa; --primary: #3793ff; }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 15px; transition: 0.3s; }
        .card { background: var(--card-bg); border-radius: 15px; padding: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        select, input { width: 100%; padding: 15px; margin: 10px 0; border-radius: 10px; border: 1px solid #ccc; font-size: 1.1rem; box-sizing: border-box; }
        .btn { width: 100%; padding: 18px; border: none; border-radius: 10px; font-weight: bold; font-size: 1.2rem; cursor: pointer; transition: 0.2s; }
        .btn-save { background-color: var(--primary); color: white; }
        .btn-reset { background-color: #6c757d; color: white; margin-top: 10px; }
        #reader { width: 100%; border-radius: 10px; overflow: hidden; }
        .hidden { display: none; }
        .data-info { background: #e7f3ff; color: #004085; padding: 15px; border-radius: 10px; margin: 10px 0; border-left: 5px solid var(--primary); }
    </style>
</head>
<body>

    <div class="card">
        <h2 style="margin-top:0">üì¶ Inventario KTMEX</h2>
        <label>1. Selecciona √Årea:</label>
        <select id="areaSelect">
            <option value="">-- Seleccionar --</option>
            <option value="PC">Production Control (PC)</option>
            <option value="WE">Welding (WE)</option>
            <option value="IL">Log√≠stica (IL)</option>
            <option value="SP">SP</option>
            <option value="ST Parts">Estampado (ST Parts)</option>
            <option value="QC">QC</option>
            <option value="SP PC">SP PC</option>
        </select>
        
        <div id="sectionScanner">
            <label>2. Escanear Kanban:</label>
            <div id="reader"></div>
        </div>
    </div>

    <div id="sectionResult" class="card hidden">
        <div class="data-info" id="qrDisplay"></div>
        
        <div id="cajasDiv">
            <label id="labelCajas">Cantidad / Cajas:</label>
            <input type="number" id="inputCajas" inputmode="numeric" placeholder="0">
        </div>

        <div id="piezasDiv" class="hidden">
            <label>Piezas Sueltas:</label>
            <input type="number" id="inputPiezas" inputmode="numeric" placeholder="0">
        </div>

        <button class="btn btn-save" id="btnSend" onclick="enviar()">üíæ Guardar en Hoja 1</button>
        <button class="btn btn-reset" onclick="reset()">üîÑ Escanear otro</button>
    </div>

    <script>
        const GOOGLE_URL = 'https://script.google.com/macros/s/AKfycbxzhsoGdr7Jf-FT5O4Zy7rZFZ6x6nCSDl7HC_sIJ32hioyXFdKnYF63dxiLw5LtIL7X7Q/exec';
        
        // Base de datos de QPC extra√≠da de tu CSV
        const dbQPC = {"K001":48,"H201":96,"K701":48,"K401":48,"T001":96,"K002":8,"H202":10,"K402":24,"T002":10,"K003":48,"H203":96,"K703":48,"K863":48,"K403":96,"T003":96,"XB28":1800,"XB14":1500,"XB19":1300,"XB13":1500,"XB24":500,"XF02":5000,"XF01":5000,"XF04":4500,"XF03":2250,"K018":24};

        let scanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 });
        let scannedData = { sebango: "", qpc: 1 };

        function onScanSuccess(text) {
            let area = document.getElementById('areaSelect').value;
            if(!area) { alert("Selecciona un √°rea primero"); return; }

            scanner.pause();
            let match = text.match(/\b(H|K|T|A|X|XB|XF)\d{2,4}\b/i);
            scannedData.sebango = match ? match[0].toUpperCase() : "Error";
            scannedData.qpc = dbQPC[scannedData.sebango] || 1;

            document.getElementById('qrDisplay').innerHTML = `<b>Kanban:</b> ${scannedData.sebango} <br> <b>QPC:</b> ${scannedData.qpc}`;
            document.getElementById('sectionScanner').classList.add('hidden');
            document.getElementById('sectionResult').classList.remove('hidden');

            // L√≥gica especial para PC
            if(area === "PC") {
                document.getElementById('labelCajas').innerText = "Cantidad Total (PC)";
                document.getElementById('piezasDiv').classList.add('hidden');
            } else {
                document.getElementById('labelCajas').innerText = "Cajas Completas";
                if(scannedData.qpc < 30) document.getElementById('piezasDiv').classList.remove('hidden');
            }
        }

        scanner.render(onScanSuccess);

        async function enviar() {
            let btn = document.getElementById('btnSend');
            btn.disabled = true; btn.innerText = "Enviando...";

            let payload = {
                area: document.getElementById('areaSelect').value,
                sebango: scannedData.sebango,
                qpc: scannedData.qpc,
                cajas: document.getElementById('inputCajas').value || 0,
                piezas: document.getElementById('inputPiezas').value || 0
            };

            try {
                await fetch(GOOGLE_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify(payload)
                });
                alert("‚úÖ Enviado a Hoja 1");
                reset();
            } catch (e) {
                alert("Error al enviar");
                btn.disabled = false;
            }
        }

        function reset() {
            document.getElementById('sectionResult').classList.add('hidden');
            document.getElementById('sectionScanner').classList.remove('hidden');
            document.getElementById('inputCajas').value = "";
            document.getElementById('inputPiezas').value = "";
            document.getElementById('btnSend').disabled = false;
            document.getElementById('btnSend').innerText = "üíæ Guardar en Hoja 1";
            scanner.resume();
        }
    </script>
</body>
</html>
