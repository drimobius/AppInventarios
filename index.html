<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Inventario QR M√≥vil</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --bg-color: #f0f2f5; --card-bg: #ffffff; --text-color: #1c1e21; --input-bg: #ffffff; --input-border: #ced4da; --highlight-bg: #e7f3ff; --primary-color: #0d6efd; --danger-color: #dc3545; }
        .dark-mode { --bg-color: #121212; --card-bg: #1e1e1e; --text-color: #e4e6eb; --input-bg: #2d2d2d; --input-border: #444; --highlight-bg: #2b3a4a; --primary-color: #3b82f6; }
        body { font-family: Arial, sans-serif; padding: 15px; margin: auto; max-width: 600px; background-color: var(--bg-color); color: var(--text-color); font-size: 18px; transition: background-color 0.3s;}
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid var(--input-border); }
        .card { background: var(--card-bg); padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 20px; }
        label { display: block; margin-top: 15px; font-weight: bold; font-size: 1.2rem; }
        select, input { width: 100%; padding: 18px; margin-top: 8px; border-radius: 8px; border: 2px solid var(--input-border); background-color: var(--input-bg); color: var(--text-color); box-sizing: border-box; font-size: 1.3rem; font-weight: bold; }
        .btn-main { width: 100%; padding: 20px; margin-top: 25px; background-color: var(--primary-color); color: white; border: none; border-radius: 8px; font-size: 1.4rem; font-weight: bold; cursor: pointer; }
        .btn-main:disabled { background-color: #6c757d; }
        .btn-secondary { background-color: var(--danger-color); margin-top: 15px; }
        .btn-toggle { padding: 10px 15px; background-color: var(--input-border); color: var(--text-color); border: none; border-radius: 20px; font-size: 1.2rem; }
        #reader { width: 100%; margin-top: 15px; border-radius: 8px; overflow: hidden; }
        .hidden { display: none !important; }
        .data-display { background: var(--highlight-bg); padding: 15px; margin-top: 10px; border-radius: 8px; font-size: 1.2rem; border-left: 6px solid var(--primary-color); }
        .alert-box { background-color: #fff3cd; color: #856404; padding: 15px; border-radius: 8px; border-left: 6px solid #ffeeba; margin-top: 15px; font-weight: bold; font-size: 1.1rem;}
        .dark-mode .alert-box { background-color: #4d4013; color: #ffecb5; border-color: #856404; }
    </style>
</head>
<body>

    <div class="header">
        <h2>üì¶ Inventario</h2>
        <button class="btn-toggle" onclick="toggleTheme()">üåì Modo</button>
    </div>

    <div id="sectionScanner" class="card">
        <label for="areaSelect">1. Selecciona tu √Årea</label>
        <select id="areaSelect">
            <option value="">-- Seleccionar √Årea --</option>
            <option value="WE">Welding (WE)</option>
            <option value="IL">Log√≠stica (IL)</option>
            <option value="SP">SP</option>
            <option value="ST Parts">Estampado (ST Parts)</option>
            <option value="QC">QC</option>
            <option value="SP PC">SP PC</option>
        </select>

        <label style="margin-top: 25px;">2. Escanear Kanban</label>
        <div id="reader"></div>
    </div>

    <div id="scanResult" class="card hidden">
        <h3 style="margin-top: 0; color: var(--primary-color); font-size: 1.4rem;">Datos Detectados</h3>
        <input type="hidden" id="sebangoVal"><input type="hidden" id="qpcVal">
        
        <div class="data-display" id="qrData"></div>
        
        <label for="cajasInput">üì¶ Cajas Completas</label>
        <input type="number" id="cajasInput" min="0" placeholder="0" inputmode="numeric">

        <div id="piezasContainer" class="hidden">
            <div class="alert-box">‚ö†Ô∏è QPC menor a 30. Captura parcial obligatoria.</div>
            <label for="piezasInput">üî© Piezas Sueltas</label>
            <input type="number" id="piezasInput" min="0" placeholder="0" inputmode="numeric">
        </div>

        <button id="btnCapturar" class="btn-main" onclick="enviarDatos()">üíæ Guardar en Base</button>
        <button class="btn-main btn-secondary" onclick="resetScanner()">‚ùå Re-escanear</button>
    </div>

    <script>
        // URL ACTUALIZADA
        const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxTi1B_Xd7120zeCkpEdVcfGj4YbhGbWZti2Z5nmqQlIzJheT68pSQcHEGtPnglXHxDgQ/exec'; 
        
        let html5QrcodeScanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: {width: 250, height: 250}, rememberLastUsedCamera: true }, false);

        function onScanSuccess(decodedText, decodedResult) {
            html5QrcodeScanner.pause();
            let rawText = decodedText.trim();
            
            // Extracci√≥n del Sebango y Parte
            let sebangoRegex = /\b(K|T|H|A)\d{3,4}\b|\b(XN|XB)\d{2,4}\b/i;
            let matchSebango = rawText.match(sebangoRegex);
            let sebango = matchSebango ? matchSebango[0].toUpperCase() : "Desconocido";

            let partRegex = /[A-Z0-9]{5}-[A-Z0-9]{5,6}/i;
            let matchPart = rawText.match(partRegex);
            let partNum = matchPart ? matchPart[0].toUpperCase() : "Desconocido";

            document.getElementById('sebangoVal').value = sebango;
            
            document.getElementById('qrData').innerHTML = `
                <span style="display:block; margin-bottom:8px;"><strong>Sebango:</strong> ${sebango}</span>
                <span style="display:block;"><strong>N¬∫ Parte:</strong> ${partNum}</span>
            `;

            document.getElementById('sectionScanner').classList.add('hidden');
            document.getElementById('scanResult').classList.remove('hidden');
            
            // Buscamos el QPC usando el Sebango
            fetchQPC(sebango);
        }

        html5QrcodeScanner.render(onScanSuccess);

        async function fetchQPC(sebango) {
            let qpcDisplay = document.getElementById('qrData');
            let tempMsg = document.createElement('span');
            tempMsg.id = 'qpcLoading';
            tempMsg.innerHTML = "<br><em>Buscando QPC en BD...</em>";
            qpcDisplay.appendChild(tempMsg);

            try {
                let response = await fetch(`${GOOGLE_APPS_SCRIPT_URL}?sebango=${sebango}`);
                let data = await response.json();
                
                if(data.encontrado) {
                    let qpc = data.qpc;
                    document.getElementById('qpcVal').value = qpc;
                    document.getElementById('qpcLoading').innerHTML = `<br><strong>QPC Base de Datos:</strong> ${qpc}`;
                    
                    if (qpc > 0 && qpc < 30) {
                        document.getElementById('piezasContainer').classList.remove('hidden');
                    } else {
                        document.getElementById('piezasContainer').classList.add('hidden');
                    }
                } else {
                    document.getElementById('qpcVal').value = 1;
                    document.getElementById('qpcLoading').innerHTML = `<br><strong style="color:red;">‚ö†Ô∏è Sebango no encontrado en BD.</strong>`;
                }
            } catch (error) {
                document.getElementById('qpcLoading').innerHTML = `<br><strong>QPC:</strong> (Error de conexi√≥n)`;
            }
        }

        async function enviarDatos() {
            let area = document.getElementById('areaSelect').value;
            let cajas = document.getElementById('cajasInput').value;
            let btn = document.getElementById('btnCapturar');

            if(!area) { alert("‚ö†Ô∏è Selecciona el √ÅREA antes de escanear."); return; }
            if(cajas === "") { alert("‚ö†Ô∏è Ingresa la cantidad de CAJAS completas."); return; }

            btn.disabled = true;
            btn.innerText = "‚è≥ Guardando...";

            let payload = {
                area: area,
                sebango: document.getElementById('sebangoVal').value,
                cajas: cajas,
                piezas: document.getElementById('piezasInput').value || 0,
                qpc: document.getElementById('qpcVal').value
            };

            try {
                // Usamos text/plain para evitar bloqueos de CORS de Google y poder leer la respuesta
                let response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(payload)
                });
                
                let result = await response.json();
                
                if(result.status === "Exito") {
                    alert("‚úÖ Guardado correctamente en " + area);
                    resetScanner();
                } else {
                    alert("‚ùå Error: " + result.message);
                    btn.disabled = false;
                    btn.innerText = "üíæ Guardar en Base";
                }

            } catch(error) {
                alert("‚ùå Error de red al guardar.");
                btn.disabled = false;
                btn.innerText = "üíæ Guardar en Base";
            }
        }

        function resetScanner() {
            document.getElementById('scanResult').classList.add('hidden');
            document.getElementById('piezasContainer').classList.add('hidden');
            document.getElementById('cajasInput').value = '';
            document.getElementById('piezasInput').value = '';
            document.getElementById('sectionScanner').classList.remove('hidden');
            html5QrcodeScanner.resume();
        }

        function toggleTheme() { document.body.classList.toggle('dark-mode'); }
    </script>
</body>
</html>
