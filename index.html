<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Inventario KTMEX - PC</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --bg-color: #f0f2f5; --card-bg: #ffffff; --text-color: #1c1e21; --input-border: #ced4da; --primary-color: #0d6efd; --danger-color: #dc3545; --highlight: #e7f3ff;}
        .dark-mode { --bg-color: #121212; --card-bg: #1e1e1e; --text-color: #e4e6eb; --input-border: #444; --primary-color: #3b82f6; --highlight: #2b3a4a;}
        body { font-family: Segoe UI, Roboto, sans-serif; padding: 15px; background-color: var(--bg-color); color: var(--text-color); max-width: 500px; margin: auto; transition: 0.3s; }
        .card { background: var(--card-bg); padding: 20px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.15); margin-bottom: 20px; }
        select, input { width: 100%; padding: 15px; margin-top: 10px; border-radius: 10px; border: 2px solid var(--input-border); background: var(--input-bg); color: var(--text-color); font-size: 1.1rem; box-sizing: border-box; }
        .btn { width: 100%; padding: 18px; border: none; border-radius: 10px; font-weight: bold; font-size: 1.2rem; cursor: pointer; margin-top: 15px; }
        .btn-save { background: var(--primary-color); color: white; }
        .btn-theme { background: none; border: 1px solid var(--input-border); color: var(--text-color); width: auto; padding: 5px 15px; border-radius: 20px; }
        .data-box { background: var(--highlight); padding: 15px; border-radius: 10px; margin: 15px 0; border-left: 5px solid var(--primary-color); }
        .hidden { display: none !important; }
        #reader { width: 100%; border-radius: 10px; overflow: hidden; }
    </style>
</head>
<body>

    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h3>üìä Registro de Inventario</h3>
        <button class="btn-theme" onclick="document.body.classList.toggle('dark-mode')">üåì</button>
    </div>

    <div id="setup" class="card">
        <label><b>Paso 1: √Årea de Trabajo</b></label>
        <select id="area">
            <option value="">-- Seleccionar --</option>
            <option value="PC">PC (Control de Producci√≥n)</option>
            <option value="IL">Log√≠stica (IL)</option>
            <option value="WE">Welding (WE)</option>
            <option value="SP">SP</option>
            <option value="ST Parts">Estampado (ST Parts)</option>
            <option value="QC">QC</option>
            <option value="SP PC">SP PC</option>
        </select>
        <br><br>
        <label><b>Paso 2: Escanear Kanban</b></label>
        <div id="reader"></div>
    </div>

    <div id="result" class="card hidden">
        <div class="data-box" id="info"></div>
        
        <div id="contCajas" class="hidden">
            <label id="labelCajas">üì¶ Cajas Completas</label>
            <input type="number" id="valCajas" inputmode="numeric" placeholder="0">
        </div>

        <div id="contPiezas" class="hidden">
            <label>üî© Piezas Sueltas</label>
            <input type="number" id="valPiezas" inputmode="numeric" placeholder="0">
        </div>

        <button class="btn btn-save" id="btnSend" onclick="enviar()">üíæ GUARDAR EN J (PC)</button>
        <button class="btn" style="background:#6c757d; color:white;" onclick="reset()">üîÑ Escanear otro</button>
    </div>

    <script>
        // BASE DE DATOS JSON (Incluida)
        const db = {"K001": 48, "H201": 96, "K099": 60, "K101": 30, "XN08": 3000, "XB10": 450}; // ... El resto de tus 1295 registros ir√≠a aqu√≠ igual que antes
        
        const scriptURL = 'TU_NUEVO_URL_DE_APPS_SCRIPT_EXEC';
        let scanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 });

        function onScan(text) {
            let area = document.getElementById('area').value;
            if(!area) { alert("Selecciona √°rea primero"); return; }

            let regex = /\b(H|K|T|A)\d{3,4}\b|\b(XN|XT)\d{2,4}\b/i;
            let match = text.match(regex);
            if(!match) { alert("QR no v√°lido para TMMGT"); return; }

            scanner.pause();
            let kanban = match[0].toUpperCase();
            let qpc = db[kanban] || 0;

            document.getElementById('info').innerHTML = `<b>Kanban:</b> ${kanban}<br><b>QPC:</b> ${qpc}`;
            document.getElementById('setup').classList.add('hidden');
            document.getElementById('result').classList.remove('hidden');

            // L√≥gica especial para PC
            if(area === "PC") {
                document.getElementById('contCajas').classList.remove('hidden');
                document.getElementById('contPiezas').classList.add('hidden');
                document.getElementById('labelCajas').innerText = "üì¶ Cantidad para PC (Col J)";
            } else {
                document.getElementById('labelCajas').innerText = "üì¶ Cajas Completas";
                if(qpc > 0 && qpc < 30) {
                    document.getElementById('contPiezas').classList.remove('hidden');
                    document.getElementById('contCajas').classList.add('hidden');
                } else {
                    document.getElementById('contCajas').classList.remove('hidden');
                    document.getElementById('contPiezas').classList.add('hidden');
                }
            }
            
            window.lastKanban = kanban;
            window.lastQPC = qpc;
        }

        scanner.render(onScan);

        async function enviar() {
            let btn = document.getElementById('btnSend');
            btn.disabled = true;
            btn.innerText = "Enviando...";

            let payload = {
                area: document.getElementById('area').value,
                sebango: window.lastKanban,
                cajas: document.getElementById('valCajas').value || 0,
                piezas: document.getElementById('valPiezas').value || 0,
                qpc: window.lastQPC
            };

            try {
                await fetch(scriptURL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify(payload)
                });
                alert("‚úÖ Registrado en Columna J (PC)");
                reset();
            } catch(e) {
                alert("Error al conectar");
                btn.disabled = false;
            }
        }

        function reset() {
            document.getElementById('result').classList.add('hidden');
            document.getElementById('setup').classList.remove('hidden');
            document.getElementById('valCajas').value = "";
            document.getElementById('valPiezas').value = "";
            scanner.resume();
        }
    </script>
</body>
</html>
